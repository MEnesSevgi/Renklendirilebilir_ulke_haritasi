<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Renklendirilebilir √úlke Haritasƒ±</title>
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""
    />
    <style>
        html, body {
            margin: 0; padding: 0; height: 100vh; width: 100vw; font-family: Arial, sans-serif;
            display: flex;
            overflow: hidden;
        }
        #map {
            flex-grow: 1;
            height: 100vh;
        }
        body.share-view #sidebar {
            display: none;
        }
        body.share-view #map {
            width: 100vw;
        }
        #mapTitle {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 20px;
            font-weight: bold;
            color: #333;
            max-width: 80%;
            text-align: center;
        }
        #sidebar {
            width: 320px;
            background: #f8f9fa;
            border-left: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        h2 {
            font-size: 18px;
            margin-top: 0;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type=color] {
            width: 100%;
            padding: 6px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
            cursor: pointer;
        }
        #mapTitleInput {
            width: calc(100% - 12px);
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 14px;
        }
        #shareButton {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        #shareButton:hover {
            background-color: #0056b3;
        }
        #info {
            margin-top: 10px;
            font-size: 14px;
            min-height: 40px;
        }
        .country-label {
            font-weight: 600;
            font-size: 12px;
            color: #222;
            text-align: center;
            white-space: nowrap;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            pointer-events: none;
            user-select: none;
            display: inline-block;
        }
        .leaflet-control-download {
            margin-bottom: 5px;
            padding: 6px 10px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        .leaflet-control-download:hover {
            background-color: #f4f4f4;
        }
        .leaflet-control-download:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        .legend {
            background: white;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            margin-bottom: 100px;
            max-height: 40vh;
            overflow-y: auto;
        }
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .layer-control-group {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 18px;
            height: 18px;
            border: 1px solid #777;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .legend-input {
            flex-grow: 1;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        #paintedCountriesList h3 {
            font-size: 16px;
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        .country-edit-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .country-edit-item input[type=text] {
            flex-grow: 1;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        .country-edit-item label {
             margin-right: 8px;
             font-weight: normal;
             font-size: 12px;
             width: 100px;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }
        /* Katman kontrol√º i√ßin √∂zel stil */
        .leaflet-top.leaflet-left {
            top: 10px !important;
            left: 10px !important;
            z-index: 1100;
        }
        .layer-control-container {
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            padding: 10px;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            width: 220px;
        }
        .layer-control-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            text-align: center;
        }
        .layer-control-item {
            margin-bottom: 6px;
            cursor: pointer;
            user-select: none;
        }
        .layer-control-item input[type=checkbox] {
            margin-right: 6px;
        }
    </style>
</head>
<body class="map-creator-view">
    <div id="mapTitle" style="display: none;">Harita Ba≈ülƒ±ƒüƒ±</div>

    <div id="map"></div>
    
    <div id="sidebar">
        <label for="mapTitleInput">üó∫Ô∏è Harita Ba≈ülƒ±ƒüƒ±:</label>
        <input type="text" id="mapTitleInput" placeholder="Haritanƒ±za bir ba≈ülƒ±k girin" value="Renklendirilebilir √úlke Haritasƒ±" />
        <p id="infoTitle" style="font-size: 12px; color: #777; margin-top: 5px;">Ba≈ülƒ±k haritada g√∂r√ºnecektir.</p>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;" />

        <h2>üé® Renklendirme Kontrol√º</h2>
        <label for="colorPicker">Renk Se√ßici:</label>
        <input type="color" id="colorPicker" value="#ff0000" />
        <div id="info">√ñnce renk se√ßin, sonra haritadan √ºlkeye tƒ±klayƒ±n.</div>

        <div id="paintedCountriesList">
             <h3>√úlke ƒ∞simlerini D√ºzenle</h3>
        </div>

        <button id="shareButton">üîó Haritayƒ± Payla≈ü (URL Olu≈ütur)</button>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // Harita olu≈üturma ve temel katmanlar
        const map = L.map('map').setView([20, 0], 2);

        const labelsGroup = L.layerGroup().addTo(map);
        const polygonsGroup = L.layerGroup().addTo(map);

        // OpenStreetMap altlƒ±k
        const osmTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '¬© OpenStreetMap contributors'
        });

        // Renkli GeoJSON katmanlarƒ± i√ßin grup (ba≈ülangƒ±√ßta bo≈ü)
        const geojsonLayersGroup = L.layerGroup();

        const colorPicker = document.getElementById('colorPicker');
        const info = document.getElementById('info');
        
        const paintedCountriesList = document.getElementById('paintedCountriesList');
        const mapTitleInput = document.getElementById('mapTitleInput');
        const mapTitleDisplay = document.getElementById('mapTitle');
        const shareButton = document.getElementById('shareButton');

        let countriesGeoJSON = null;
        let grayBordersLayer = null; 
        
        const selectedCountryLayers = {};
        const colorLegends = {}; 
        let currentBasemapSelection = 'osmBasemap';

        const urlParams = new URLSearchParams(window.location.search);
        const isShareView = urlParams.has('config');

        if (!isShareView) {
            mapTitleDisplay.style.display = 'block';
        } else {
            document.body.classList.add('share-view');
            const downloadControlElement = document.querySelector('.leaflet-control-download');
            if(downloadControlElement) downloadControlElement.parentElement.remove();
        }

        const legendControl = L.Control.extend({
            options: { position: 'bottomright' },
            onAdd: function (map) {
                this._div = L.DomUtil.create('div', 'info legend');
                this._div.id = 'legendContainer';
                L.DomEvent.disableClickPropagation(this._div);
                return this._div;
            }
        });
        map.addControl(new legendControl());
        const legendContainer = document.getElementById('legendContainer');

        if (!isShareView) {
            const DownloadControl = L.Control.extend({
                options: { position: 'bottomleft' },
                onAdd: function (map) {
                    const button = L.DomUtil.create('button', 'leaflet-control-download');
                    button.id = 'snapshotButton';
                    button.innerHTML = '‚úÇÔ∏è Ekran Alƒ±ntƒ±sƒ± ƒ∞√ßin Tƒ±kla';
                    L.DomEvent.on(button, 'click', showScreenshotInstructions); 
                    L.DomEvent.disableClickPropagation(button);
                    return button;
                }
            });
            map.addControl(new DownloadControl());
        }

        mapTitleInput.addEventListener('input', () => {
            const title = mapTitleInput.value.trim() || "Harita Ba≈ülƒ±ƒüƒ±";
            mapTitleDisplay.textContent = title;
        });
        mapTitleInput.dispatchEvent(new Event('input'));

        // UTF-8 uyumlu Base64 encode/decode
        function base64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
        }

        function base64DecodeUnicode(str) {
            return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        function saveMapConfig() {
            const config = {
                countries: Object.keys(selectedCountryLayers).reduce((acc, id) => {
                    const country = selectedCountryLayers[id];
                    const name = country.name !== country.originalName ? country.name : undefined;
                    if(name) acc[id] = { colors: country.colors, name };
                    else acc[id] = { colors: country.colors };
                    return acc;
                }, {}),
                legends: Object.keys(colorLegends).reduce((acc, color) => {
                    if (colorLegends[color].label) acc[color] = colorLegends[color].label;
                    return acc;
                }, {}),
                title: mapTitleInput.value.trim() || undefined,
                view: currentBasemapSelection,
                center: map.getCenter().lat.toFixed(4) + ',' + map.getCenter().lng.toFixed(4),
                zoom: map.getZoom()
            };
            
            const jsonString = JSON.stringify(config);
            return base64EncodeUnicode(jsonString);
        }

        function loadMapConfig(encodedConfig) {
            try {
                const jsonString = base64DecodeUnicode(encodedConfig);
                const config = JSON.parse(jsonString);
                
                if (config.title) {
                    mapTitleDisplay.textContent = config.title;
                    mapTitleDisplay.style.display = 'block';
                } else {
                    mapTitleDisplay.style.display = 'none';
                }

                if (config.view) {
                    currentBasemapSelection = config.view;
                }

                if (config.center && config.zoom) {
                    const [lat, lng] = config.center.split(',');
                    map.setView([parseFloat(lat), parseFloat(lng)], parseInt(config.zoom));
                }

                if (config.legends) {
                    for (const color in config.legends) {
                        colorLegends[color] = { label: config.legends[color], countries: [] };
                    }
                }
                
                return config.countries || {};

            } catch (error) {
                console.error("Harita konfig√ºrasyonu y√ºklenemedi:", error);
                return {};
            }
        }

        if (!isShareView) {
            shareButton.addEventListener('click', () => {
                const encodedConfig = saveMapConfig();
                const shareURL = window.location.origin + window.location.pathname + '?config=' + encodedConfig;

                navigator.clipboard.writeText(shareURL).then(() => {
                    alert('Payla≈üƒ±m baƒülantƒ±sƒ± panoya kopyalandƒ±:\n' + shareURL);
                }).catch(err => {
                    console.error('Baƒülantƒ± kopyalanamadƒ±:', err);
                    alert('Baƒülantƒ± olu≈üturuldu (Panoya kopyalanamadƒ±, elle kopyalayƒ±n):\n' + shareURL);
                });
            });
        }

        function getCountryName(feature) {
             return feature.properties.ADMIN || feature.properties.NAME || feature.properties.name || "Bilinmeyen";
        }
        function getCountryId(feature) {
             const id = feature.properties.ADMIN || feature.properties.NAME;
             return id ? id.trim() : getCountryName(feature).trim();
        }
        function getLargestPolygonCentroid(feature) {
             const geom = feature.geometry;
             if (geom.type === "MultiPolygon") {
                 let maxArea = 0;
                 let largestPolygon = null;
                 geom.coordinates.forEach(polygonCoords => {
                     const poly = turf.polygon(polygonCoords);
                     const area = turf.area(poly);
                     if (area > maxArea) {
                         maxArea = area;
                         largestPolygon = poly;
                     }
                 });
                 if (largestPolygon) {
                     return turf.centroid(largestPolygon).geometry.coordinates;
                 }
             } else if (geom.type === "Polygon") {
                 return turf.centroid(feature).geometry.coordinates;
             }
             return turf.centroid(feature).geometry.coordinates;
        }

        function updateCountryEditList() {
             paintedCountriesList.innerHTML = '<h3>√úlke ƒ∞simlerini D√ºzenle</h3>';
             
             for (const countryId in selectedCountryLayers) {
                 const country = selectedCountryLayers[countryId];
                 
                 const itemDiv = document.createElement('div');
                 itemDiv.className = 'country-edit-item';
                 
                 const label = document.createElement('label');
                 label.textContent = country.originalName || country.name; 
                 label.title = country.originalName || country.name; 
                 
                 const input = document.createElement('input');
                 input.type = 'text';
                 input.value = country.name; 
                 input.placeholder = country.originalName;
                 input.setAttribute('data-country-id', countryId);

                 input.addEventListener('input', (e) => {
                     const newName = e.target.value.trim() || country.originalName;
                     
                     selectedCountryLayers[countryId].name = newName;
                     
                     const marker = selectedCountryLayers[countryId].label;
                     if (marker) {
                          const newIcon = L.divIcon({
                              className: 'country-label',
                              html: newName,
                              iconSize: [100, 20],
                              iconAnchor: [50, 10]
                          });
                          marker.setIcon(newIcon);
                     }
                     
                     info.textContent = `${country.originalName} i√ßin etiket "${newName}" olarak g√ºncellendi.`;
                 });

                 itemDiv.appendChild(label);
                 itemDiv.appendChild(input);
                 paintedCountriesList.appendChild(itemDiv);
             }

             if (Object.keys(selectedCountryLayers).length === 0) {
                  const p = document.createElement('p');
                  p.style.fontSize = '12px';
                  p.style.color = '#777';
                  p.textContent = 'Hen√ºz boyanan √ºlke yok.';
                  paintedCountriesList.appendChild(p);
             }
        }

        function updateLegend() {
             legendContainer.innerHTML = '<div class="legend-title">Boyanan Renkler ve A√ßƒ±klamalar</div>';

             const uniqueColors = {};
             for (const id in selectedCountryLayers) {
                const colors = selectedCountryLayers[id].colors;
                colors.forEach(color => {
                  if (!uniqueColors[color]) {
                      const existingLabel = colorLegends[color] ? colorLegends[color].label : '';
                      uniqueColors[color] = existingLabel;
                  }
                });
             }
             
             for (const color in uniqueColors) {
                let existingLabel = uniqueColors[color];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = color;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'legend-input';
                input.placeholder = `A√ßƒ±klama giriniz (√∂rn: ${color})`;
                input.value = existingLabel;

                input.addEventListener('input', (e) => {
                    if (!colorLegends[color]) { colorLegends[color] = { label: '', countries: [] }; }
                    colorLegends[color].label = e.target.value;
                });
                
                if (!colorLegends[color]) {
                    colorLegends[color] = { label: existingLabel, countries: [] };
                }

                itemDiv.appendChild(colorBox);
                itemDiv.appendChild(input);
                legendContainer.appendChild(itemDiv);
             }
        }

        // √áok renkli destekli g√ºncellenmi≈ü fonksiyon
        function addOrUpdateSelectedCountry(feature, fillColor, displayName) {
            const countryId = getCountryId(feature);
            const originalName = getCountryName(feature);
            const color = fillColor || colorPicker.value;

            const currentDisplayName = displayName || (selectedCountryLayers[countryId] ? selectedCountryLayers[countryId].name : originalName);

            // Eƒüer √ºlke zaten se√ßilmi≈üse, renk dizisine ekle (aynƒ± renk varsa ekleme)
            if (selectedCountryLayers[countryId]) {
                // Yeni renk yoksa ekle
                if (!selectedCountryLayers[countryId].colors.includes(color)) {
                    selectedCountryLayers[countryId].colors.push(color);
                }
            } else {
                // Yeni √ºlke i√ßin renk dizisi olu≈ütur
                selectedCountryLayers[countryId] = {
                    colors: [color],
                    name: currentDisplayName,
                    originalName: originalName,
                    polygons: [], // √ßoklu renkli poligonlar i√ßin
                    label: null
                };
            }

            // √ñnce eski poligonlarƒ± kaldƒ±r
            if (selectedCountryLayers[countryId].polygons.length > 0) {
                selectedCountryLayers[countryId].polygons.forEach(poly => polygonsGroup.removeLayer(poly));
                selectedCountryLayers[countryId].polygons = [];
            }
            if (selectedCountryLayers[countryId].label) {
                labelsGroup.removeLayer(selectedCountryLayers[countryId].label);
                selectedCountryLayers[countryId].label = null;
            }

            const colors = selectedCountryLayers[countryId].colors;
            const geom = feature.geometry;

            // √áokgeni yatay olarak renk sayƒ±sƒ±na g√∂re dilimleyecek yardƒ±mcƒ± fonksiyon
            function splitPolygonHorizontally(feature, parts) {
                const resultPolygons = [];
                const bbox = turf.bbox(feature); // [minX, minY, maxX, maxY]
                const minY = bbox[1];
                const maxY = bbox[3];
                const height = maxY - minY;
                const step = height / parts;

                for (let i = 0; i < parts; i++) {
                    const sliceMinY = minY + i * step;
                    const sliceMaxY = sliceMinY + step;

                    // Dikey kutu poligonu (slice)
                    const slicePoly = turf.bboxPolygon([bbox[0], sliceMinY, bbox[2], sliceMaxY]);

                    // feature ile kesi≈üim al
                    const intersection = turf.intersect(feature, slicePoly);

                    if (intersection) {
                        resultPolygons.push(intersection);
                    }
                }
                return resultPolygons;
            }

            // Poligonlarƒ± olu≈ütur
            let polygonsToDraw = [];

            if (geom.type === "MultiPolygon" || geom.type === "Polygon") {
                polygonsToDraw = splitPolygonHorizontally(feature, colors.length);
            } else {
                // Geometri tipi desteklenmiyorsa t√ºm poligon tek renk
                polygonsToDraw = [feature];
            }

            // Her par√ßayƒ± farklƒ± renkte √ßiz
            polygonsToDraw.forEach((polyFeature, index) => {
                const polyColor = colors[index] || colors[colors.length - 1];
                const polygonLayer = L.geoJSON(polyFeature, {
                    style: {
                        fillColor: polyColor,
                        color: 'white',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.7,
                        dashArray: ''
                    }
                }).addTo(polygonsGroup);
                selectedCountryLayers[countryId].polygons.push(polygonLayer);
            });

            // Etiket olu≈ütur
            const centroidCoords = getLargestPolygonCentroid(feature);
            const latlng = [centroidCoords[1], centroidCoords[0]];

            const label = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'country-label',
                    html: currentDisplayName,
                    iconSize: [100, 20],
                    iconAnchor: [50, 10]
                }),
                interactive: false
            }).addTo(labelsGroup);

            selectedCountryLayers[countryId].label = label;
            selectedCountryLayers[countryId].name = currentDisplayName;

            updateLegend();
            if (!isShareView) updateCountryEditList();

            if (!isShareView) info.textContent = `${originalName} se√ßildi ve renklendirildi. Toplam ${Object.keys(selectedCountryLayers).length} farklƒ± √ºlke boyandƒ±. (Renk sayƒ±sƒ±: ${colors.length})`;
        }

        // Payla≈üƒ±m g√∂r√ºn√ºm√ºnde katman kontrol√º olu≈üturma ve y√∂netme
        if (isShareView) {
            // Katman kontrol√º i√ßin container (sol √ºst k√∂≈üe)
            const layerControlContainer = L.DomUtil.create('div', 'layer-control-container leaflet-control');
            layerControlContainer.style.position = 'absolute';
            layerControlContainer.style.top = '10px';
            layerControlContainer.style.left = '10px';
            layerControlContainer.style.zIndex = 1100;

            // Katman kontrol ba≈ülƒ±ƒüƒ±
            const layerControlTitle = document.createElement('div');
            layerControlTitle.className = 'layer-control-title';
            layerControlTitle.textContent = 'Katmanlar';
            layerControlContainer.appendChild(layerControlTitle);

            // OpenStreetMap altlƒ±k se√ßeneƒüi
            const osmLayerControlItem = document.createElement('div');
            osmLayerControlItem.className = 'layer-control-item';
            const osmCheckbox = document.createElement('input');
            osmCheckbox.type = 'checkbox';
            osmCheckbox.id = 'layer-osm';
            osmCheckbox.checked = true;
            osmLayerControlItem.appendChild(osmCheckbox);
            const osmLabel = document.createElement('label');
            osmLabel.htmlFor = 'layer-osm';
            osmLabel.textContent = 'OpenStreetMap Altlƒ±k';
            osmLayerControlItem.appendChild(osmLabel);
            layerControlContainer.appendChild(osmLayerControlItem);

            // Renkli GeoJSON katmanlarƒ± i√ßin kontrol (checkbox listesi)
            const geojsonLayersControlTitle = document.createElement('div');
            geojsonLayersControlTitle.style.marginTop = '10px';
            geojsonLayersControlTitle.style.fontWeight = 'bold';
            geojsonLayersControlTitle.textContent = 'Renkli GeoJSON Katmanlarƒ±';
            layerControlContainer.appendChild(geojsonLayersControlTitle);

            // GeoJSON katman checkbox container
            const geojsonCheckboxesContainer = document.createElement('div');
            geojsonCheckboxesContainer.style.maxHeight = '300px';
            geojsonCheckboxesContainer.style.overflowY = 'auto';
            layerControlContainer.appendChild(geojsonCheckboxesContainer);

            // Katman kontrol√º DOM'u haritaya ekle
            map.getContainer().appendChild(layerControlContainer);

            // GeoJSON katmanlarƒ±nƒ± tutan nesne
            const geojsonLayersMap = {};

            // GeoJSON verisini y√ºkle ve katmanlarƒ± olu≈ütur
            fetch('https://raw.githubusercontent.com/MEnesSevgi/altlik-harita/main/map%20(5).geojson')
                .then(res => res.json())
                .then(data => {
                    countriesGeoJSON = data;

                    // GeoJSON'dan her √ºlke i√ßin ayrƒ± katmanlar olu≈üturacaƒüƒ±z
                    data.features.forEach((feature, index) => {
                        const countryId = getCountryId(feature);

                        const countryLayer = L.geoJSON(feature, {
                            style: {
                                fillColor: '#3388ff',
                                color: 'white',
                                weight: 1,
                                opacity: 1,
                                fillOpacity: 0.7
                            }
                        });

                        geojsonLayersMap[countryId] = countryLayer;

                        // Katman kontrol√ºne checkbox ekle
                        const layerControlItem = document.createElement('div');
                        layerControlItem.className = 'layer-control-item';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = 'layer-geojson-' + index;
                        checkbox.setAttribute('data-layer-id', countryId);
                        checkbox.checked = false;

                        const label = document.createElement('label');
                        label.htmlFor = checkbox.id;
                        label.textContent = getCountryName(feature);

                        layerControlItem.appendChild(checkbox);
                        layerControlItem.appendChild(label);
                        geojsonCheckboxesContainer.appendChild(layerControlItem);

                        // Checkbox deƒüi≈üikliklerinde haritayƒ± g√ºncelle
                        checkbox.addEventListener('change', () => {
                            updateMapLayers();
                        });
                    });

                    // Payla≈üƒ±m g√∂r√ºn√ºm√ºnde config y√ºkle ve katmanlarƒ± se√ß
                    let countriesToPaint = {};
                    const encodedConfig = urlParams.get('config');
                    if (encodedConfig) {
                        countriesToPaint = loadMapConfig(encodedConfig);
                    }

                    if (Object.keys(countriesToPaint).length > 0) {
                        Object.keys(countriesToPaint).forEach(countryId => {
                            const config = countriesToPaint[countryId];
                            if (config) {
                                // Katman checkbox i≈üaretle
                                const checkbox = geojsonCheckboxesContainer.querySelector(`input[data-layer-id="${countryId}"]`);
                                if (checkbox) checkbox.checked = true;

                                // Renkleri uygula
                                const feature = data.features.find(f => getCountryId(f) === countryId);
                                if (feature) {
                                    if (config.colors && Array.isArray(config.colors)) {
                                        config.colors.forEach(color => {
                                            addOrUpdateSelectedCountry(feature, color, config.name);
                                        });
                                    } else if (config.color) {
                                        addOrUpdateSelectedCountry(feature, config.color, config.name);
                                    }
                                }
                            }
                        });
                    }

                    // Ba≈ülangƒ±√ßta OpenStreetMap ve se√ßili GeoJSON katmanlarƒ±nƒ± g√∂ster
                    updateMapLayers();
                })
                .catch(err => {
                    console.error("GeoJSON y√ºklenirken hata:", err);
                    info.textContent = "Harita y√ºklenemedi.";
                });

            // Katmanlarƒ± g√ºncelleyen fonksiyon
            function updateMapLayers() {
                // OpenStreetMap altlƒ±k kontrol√º
                if (osmCheckbox.checked) {
                    if (!map.hasLayer(osmTileLayer)) map.addLayer(osmTileLayer);
                } else {
                    if (map.hasLayer(osmTileLayer)) map.removeLayer(osmTileLayer);
                }

                // GeoJSON katmanlarƒ±nƒ±n kontrol√º
                geojsonLayersGroup.clearLayers();

                geojsonCheckboxesContainer.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
                    if (checkbox.checked) {
                        const layerId = checkbox.getAttribute('data-layer-id');
                        const layer = geojsonLayersMap[layerId];
                        if (layer) {
                            geojsonLayersGroup.addLayer(layer);
                        }
                    }
                });

                if (!map.hasLayer(geojsonLayersGroup)) {
                    map.addLayer(geojsonLayersGroup);
                }
            }
        } else {
            // Normal modda: GeoJSON verisini y√ºkle ve haritaya poligonlarƒ± ekle, renk atama i≈ülemi i√ßin
            fetch('https://raw.githubusercontent.com/MEnesSevgi/altlik-harita/main/map%20(5).geojson')
                .then(res => res.json())
                .then(data => {
                    countriesGeoJSON = data;
                    if (!isShareView) info.textContent = "Renk se√ßin ve haritadan √ºlkeye tƒ±klayƒ±n.";
                })
                .catch(err => {
                    console.error("GeoJSON y√ºklenirken hata:", err);
                    if (!isShareView) info.textContent = "Harita y√ºklenemedi.";
                });

            map.on('click', e => {
                if (!countriesGeoJSON) return;

                const selectedColor = colorPicker.value;
                if (!selectedColor) {
                    info.textContent = "L√ºtfen √∂nce bir renk se√ßin.";
                    return;
                }

                let foundFeature = null;

                for (const feature of countriesGeoJSON.features) {
                    if (feature.geometry && turf.booleanPointInPolygon(turf.point([e.latlng.lng, e.latlng.lat]), feature)) {
                        foundFeature = feature;
                        break;
                    }
                }

                if (!foundFeature) {
                    info.textContent = "Hi√ßbir √ºlke se√ßilmedi.";
                    return;
                }

                const countryId = getCountryId(foundFeature);
                
                if (!countryId || countryId === "Bilinmeyen") {
                    info.textContent = `${getCountryName(foundFeature)} i√ßin ge√ßerli bir kimlik bulunamadƒ±. Boyanamaz.`;
                    return;
                }

                addOrUpdateSelectedCountry(foundFeature, selectedColor);
            });

            updateLegend();
            updateCountryEditList();
            // OpenStreetMap altlƒ±k varsayƒ±lan olarak eklenir
            osmTileLayer.addTo(map);
        }

        function showScreenshotInstructions() {
             alert(
                "Harita g√∂r√ºnt√ºs√ºn√º almak i√ßin l√ºtfen tarayƒ±cƒ±nƒ±zƒ±n veya i≈ületim sisteminizin ekran alƒ±ntƒ±sƒ± (screenshot) aracƒ±nƒ± kullanƒ±n.\n\n" +
                "Kƒ±sayollar:\n" +
                "Windows: Shift + Windows Tu≈üu + S\n" +
                "macOS: Shift + Command (‚åò) + 4\n\n" +
                "Bu y√∂ntem, haritadaki etiket kayma sorununu √ß√∂zmenize yardƒ±mcƒ± olacaktƒ±r."
             );
        };
    </script>
</body>
</html>
